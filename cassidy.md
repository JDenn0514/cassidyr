# cassidyr Package Development Context

## Project Overview

**cassidyr** is an R package that provides a client for the CassidyAI API, enabling seamless integration of AI-powered assistants into R workflows. The package is designed with a security-first approach, tidyverse-style conventions, and follows R package development best practices.

## Package Information

- **Name:** cassidyr
- **Purpose:** R client for CassidyAI API with context-aware chat capabilities
- **Target Audience:** R users who want to integrate AI assistance into their workflows
- **Current Status:** Phase 3 complete (Interactive Shiny Chatbot), ready for Phase 4 (IDE Integration)

## Architecture & Design Philosophy

### Core Principles

1. **Security First**
   - No credentials in code - always use environment variables
   - Credentials stored in `.Renviron` (gitignored)
   - No real data in automated tests
   - Manual tests separate in `tests/manual/` (excluded from builds)

2. **Tidyverse Style**
   - All functions use snake_case
   - Pipe-friendly design
   - Clear, descriptive function names
   - Use native pipe `|>` in examples

3. **Naming Conventions**
   - All exported functions use `cassidy_` prefix
   - Layer-specific organization:
     - `cassidy_create_*`, `cassidy_send_*` (API functions)
     - `cassidy_chat()`, `cassidy_session()` (chat interface)
     - `cassidy_context_*()` (context gathering)
     - `cassidy_app()` (Shiny chat interface)
   - Internal helpers use `.` prefix (e.g., `.detect_ide()`)

4. **User-Friendly Errors**
   - Use `cli::cli_abort()` for errors with helpful messages
   - Validate inputs early and clearly
   - Provide actionable error messages

5. **Sensible Defaults**
   - Environment variables for credentials
   - Automatic fallbacks (e.g., codebook â†’ skim â†’ basic)
   - Works out of the box when possible

## Package Structure

cassidyr/
â”œâ”€â”€ R/
â”‚   â”œâ”€â”€ api-core.R              âœ“ Complete (API layer)
â”‚   â”œâ”€â”€ chat-core.R             âœ“ Complete (chat interface)
â”‚   â”œâ”€â”€ chat-ui.R               âœ“ Complete (Shiny app main)
â”‚   â”œâ”€â”€ chat-ui-components.R    âœ“ Complete (UI components)
â”‚   â”œâ”€â”€ chat-server-handlers.R  âœ“ Complete (Server handlers)
â”‚   â”œâ”€â”€ chat-conversation.R     âœ“ Complete (S7 ConversationManager)
â”‚   â”œâ”€â”€ chat-persistence.R      âœ“ Complete (Save/load conversations)
â”‚   â”œâ”€â”€ chat-helpers.R          âœ“ Complete (Write code/files)
â”‚   â”œâ”€â”€ chat-css.R              âœ“ Complete (App styling + copy code button)
â”‚   â”œâ”€â”€ chat-js.R               âœ“ Complete (App JavaScript + copy code button)
â”‚   â”œâ”€â”€ context-project.R       âœ“ Complete (project context)
â”‚   â”œâ”€â”€ context-data.R          âœ“ Complete (data frame context)
â”‚   â”œâ”€â”€ context-env.R           âœ“ Complete (environment context)
â”‚   â”œâ”€â”€ context-file.R          âœ“ Complete (file context)
â”‚   â”œâ”€â”€ context-combine.R       âœ“ Complete (combine contexts)
â”‚   â”œâ”€â”€ context-tools.R         âœ“ Complete (internal helpers)
â”‚   â”œâ”€â”€ scripts.R               âœ“ Complete (script-to-quarto, commenting)
â”‚   â”œâ”€â”€ utils.R                 âœ“ Complete (%||% operator)
â”‚   â”œâ”€â”€ cassidyr-package.R      âœ“ Complete (package docs)
â”‚   â””â”€â”€ addins.R                â³ Phase 4 (RStudio/Positron addins)
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ testthat/
â”‚   â”‚   â”œâ”€â”€ test-api-core.R           âœ“ Complete
â”‚   â”‚   â”œâ”€â”€ test-chat-core.R          âœ“ Complete
â”‚   â”‚   â”œâ”€â”€ test-context-project.R    âœ“ Complete
â”‚   â”‚   â”œâ”€â”€ test-context-data.R       âœ“ Complete
â”‚   â”‚   â”œâ”€â”€ test-context-environment.R âœ“ Complete
â”‚   â”‚   â””â”€â”€ test-context-tools.R      âœ“ Complete
â”‚   â””â”€â”€ manual/
â”‚       â”œâ”€â”€ test-api-live.R
â”‚       â”œâ”€â”€ test-chat-live.R
â”‚       â””â”€â”€ test-context-live.R       âœ“ Complete
â”‚
â””â”€â”€ man/ (generated by roxygen2)

## Development Preferences

### Documentation Standards

- **roxygen2 with markdown** (@md in DESCRIPTION)
- All exported functions must have:
  - Complete parameter documentation
  - @return descriptions
  - @examples (with `\dontrun{}` for API calls)
  - @export tag for public functions
- Use markdown formatting in documentation
- Link related functions with @seealso
- Include usage examples that are realistic

### Testing Standards

- **testthat 3e** for all tests
- **Simplified testing approach** (not httptest2):
  - Unit tests validate R code logic without API calls
  - Mocking used sparingly (only when needed)
  - Manual tests verify real API integration
  - CRAN-compatible (no required API credentials)
- Test structure:
  - Use `withr::with_tempdir()` for file operations
  - Use `skip_if()` for environment-dependent tests
  - Use `skip_on_cran()` for system command tests
  - Test error handling and edge cases
- **Important**: Don't test cli output text directly
  - cli functions write to stderr, not stdout
  - Use `expect_no_error()` instead of `expect_output()` for cli messages
  - Test structure and behavior, not exact formatting

### Code Style

- Follow tidyverse style guide
- Use `paste0()` for string concatenation (not `sprintf()`)
- Prefer `|>` pipe for R >= 4.1 examples
- Maximum line length: 80 characters
- Use meaningful variable names
- Comment complex logic

### Dependencies

- **Minimize dependencies** where reasonable
- Current imports:
  - httr2 (>= 1.0.0) - HTTP requests
  - cli (>= 3.6.0) - User interface
  - rlang (>= 1.1.0) - Programming tools
- Suggested packages:
  - testthat (>= 3.0.0)
  - withr
  - shiny - Chat UI
  - bslib - Modern theming
  - S7 - OOP for ConversationManager
  - markdown - Render chat messages
  - adlgraphs (for codebook)
  - skimr (for data summaries)
  - gert (for Git operations)
  - rstudioapi
- Prefer base R for simple operations

## API Details

### CassidyAI API

- **Base URL:** `https://app.cassidyai.com/api`
- **Authentication:** Bearer token in Authorization header
- **Environment Variables:**
  - `CASSIDY_API_KEY` - API key
  - `CASSIDY_ASSISTANT_ID` - Assistant ID
- **Endpoints:**
  - `POST /assistants/thread/create` - Create thread
  - `POST /assistants/message/create` - Send message
  - `GET /assistants/thread/get` - Get thread history
  - `GET /assistants/threads/get` - List threads
- **Retry Logic:**
  - Automatic retry on 429 (rate limit) and 503/504 (server errors)
  - Max 3 retries
  - 120-second timeout (configurable)

## Key Design Patterns

### S3 Objects

- `cassidy_response` - Single API response
- `cassidy_thread` - Thread with message history
- `cassidy_thread_list` - List of threads
- `cassidy_session` - Stateful chat session
- `cassidy_chat` - Chat result with thread info
- `cassidy_context` - Project context
- `cassidy_df_description` - Data frame description
- `cassidy_data_issues` - Data quality issues

### S7 Classes

- `ConversationManager` - Manages Shiny chat state with reactive values
  - Methods: `conv_get_all`, `conv_get_current`, `conv_update_current`,
    `conv_create_new`, `conv_switch_to`, `conv_delete`, `conv_add_message`,
    `conv_save_current`, `conv_load_and_set`

### Print Methods

- All S3 classes have print methods
- Use `cli` for formatted output (goes to stderr)
- Use `cat()` for actual content (goes to stdout)
- Always return invisibly: `invisible(x)`

### Context System

- Context sent **once at thread creation** (not per message)
- Tiered levels: minimal, standard, comprehensive
- Multiple methods with automatic fallback
- Configuration files automatically detected

### Conversation Persistence

- Conversations saved to `tools::R_user_dir("cassidyr", "data")/conversations/`
- Auto-save on message and session end
- Functions: `cassidy_list_conversations()`, `cassidy_export_conversation()`,
  `cassidy_delete_conversation()`

## Common Development Tasks

### Adding a New Function

1. Write function in appropriate `R/` file
2. Add roxygen2 documentation with @export
3. Document with `devtools::document()`
4. Write tests in corresponding `tests/testthat/test-*.R`
5. Add example to manual test file if needed
6. Update README if it's a major feature

### Testing Workflow

- Run all tests: `devtools::test()`
- Run specific test file: `devtools::test_active_file()`
- Check package: `devtools::check()`
- Manual testing: `source("tests/manual/test-context-live.R")`

## Common Pitfalls to Avoid

1. **Don't use `sprintf()`** - use paste0() instead
2. **Don't test cli output directly** - test structure/behavior instead
3. **Don't use `.format_num()` inside cli strings** - format values first
4. **Don't forget `skip_on_cran()`** for system commands
5. **Don't make git tests strict** - git behavior varies by environment
6. **Always use `suppressMessages()`** around `use_cassidy_md()` in tests

## IDE Support

The package is designed to work across multiple IDEs:

- RStudio - Primary development environment
- Positron - Growing alternative, actively supported
- VS Code - With R extension
- Terminal - All features work in plain R

Functions detect IDE automatically and adapt behavior (e.g., file opening).

## Development Phases

### âœ… Phase 1: API Layer (Complete)

- `cassidy_create_thread()` - Create conversation threads
- `cassidy_send_message()` - Send messages to assistants
- `cassidy_get_thread()` - Retrieve thread history
- `cassidy_list_threads()` - List available threads

### âœ… Phase 2: Context System (Complete)

- `cassidy_context_project()` - Gather project context
- `cassidy_context_data()` - Describe data frames
- `cassidy_context_env()` - Environment information
- `cassidy_describe_file()` - File summaries
- `use_cassidy_md()` - Create configuration file

### âœ… Phase 3: Interactive Shiny Chatbot (Complete)

- `cassidy_app()` - Launch interactive Shiny chat interface
- Context integration - Automatic project/data context in chat
- Conversation persistence - Auto-save/load conversation history
- File context management - Add/remove/refresh files in context
- Conversation sidebar - Switch between multiple conversations
- Export conversations - Save chat history as markdown
- Mobile-responsive design - Collapsible sidebar, clean UI
- **Copy code button** - One-click copy for code blocks

### â³ Phase 4: IDE Integration (Next)

**Planned Features:**

- RStudio/Positron addins for code assistance
- `cassidy_document_function()` - Generate roxygen2 docs
- `cassidy_explain_selection()` - Explain selected code
- `cassidy_refactor_selection()` - Improve code
- `cassidy_debug_error()` - Help debug errors

**Implementation Notes:**

- Use `rstudioapi` when available
- Provide fallbacks for other IDEs
- Keep addins optional (in Suggests)
- Test across different environments

### ðŸ”® Phase 5: Agent System (Future)

- `cassidy_agent()` - Iterative problem solving
- `cassidy_execute_code()` - Safe code execution with sandboxing
- Multi-step workflows with state management
- Tool calling and function execution

### ðŸ”® Phase 6: Survey Research Tools (Future)

- `cassidy_interpret_efa()` - EFA interpretation with recommendations
- `cassidy_write_methods()` - Generate methods sections in APA format
- `cassidy_survey_codebook()` - Enhanced codebook for survey data
- `cassidy_scale_analysis()` - Comprehensive scale reliability analysis

## Important Context

- This package is **self-documenting** - it can use its own context system to help build itself
- When working on cassidyr, always gather context first with `cassidy_context_project(level = "comprehensive")`

## Package Development Status

- The package follows **ellmer's testing pattern** for API tests
- Ready for **CRAN submission** after Phase 4 (IDE Integration)
- Built with **R 4.1+** in mind (native pipe `|>` support)
- Currently on **Phase 3 complete** - Interactive Shiny Chatbot implemented

## Communication Preferences

When providing help with cassidyr development:

1. **Follow established patterns** - consistency matters across the codebase
2. **Provide complete code blocks** - ready to copy and use
3. **Include tests** - always provide corresponding tests for new functions
4. **Update documentation** - include roxygen2 comments with all code
5. **Explain design decisions** - help me understand the "why" behind choices
6. **Consider edge cases** - think about what could go wrong and handle it
7. **Keep it simple** - prefer clear over clever code

## Code Review Checklist

Before finalizing any new code:

- [ ] Function follows naming conventions (`cassidy_*` prefix)
- [ ] All parameters documented with @param
- [ ] @return value described
- [ ] @examples provided (with `\dontrun{}` for API calls)
- [ ] Tests pass with `devtools::test()`
- [ ] No hardcoded credentials or sensitive data
- [ ] Error handling implemented with helpful messages
- [ ] Works without optional dependencies (graceful fallbacks)
- [ ] Documentation renders correctly with `devtools::document()`
- [ ] Package passes `devtools::check()` with no errors or warnings
