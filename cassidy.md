# cassidyr Package Development Context

## Project Overview

**cassidyr** is an R package that provides a client for the CassidyAI
API, enabling seamless integration of AI-powered assistants into R
workflows. The package is designed with a security-first approach,
tidyverse-style conventions, and follows R package development best
practices.

## Package Information

- **Name:** cassidyr
- **Purpose:** R client for CassidyAI API with context-aware chat
  capabilities
- **Target Audience:** R users who want to integrate AI assistance into
  their workflows
- **Current Status:** Phase 3 complete (Interactive Shiny Chatbot),
  ready for Phase 4 (IDE Integration)

## Architecture & Design Philosophy

### Core Principles

1.  **Security First**
    - No credentials in code - always use environment variables
    - Credentials stored in `.Renviron` (gitignored)
    - No real data in automated tests
    - Manual tests separate in `tests/manual/` (excluded from builds)
2.  **Tidyverse Style**
    - All functions use snake_case
    - Pipe-friendly design
    - Clear, descriptive function names
    - Use native pipe `|>` in examples
3.  **Naming Conventions**
    - All exported functions use `cassidy_` prefix
    - Layer-specific organization:
      - `cassidy_create_*`, `cassidy_send_*` (API functions)
      - [`cassidy_chat()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_chat.md),
        [`cassidy_session()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_session.md)
        (chat interface)
      - `cassidy_context_*()` (context gathering)
      - [`cassidy_app()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_app.md)
        (Shiny chat interface)
    - Internal helpers use `.` prefix (e.g., `.detect_ide()`)
4.  **User-Friendly Errors**
    - Use
      [`cli::cli_abort()`](https://cli.r-lib.org/reference/cli_abort.html)
      for errors with helpful messages
    - Validate inputs early and clearly
    - Provide actionable error messages
5.  **Sensible Defaults**
    - Environment variables for credentials
    - Automatic fallbacks (e.g., codebook ‚Üí skim ‚Üí basic)
    - Works out of the box when possible

## Package Structure

cassidyr/ ‚îú‚îÄ‚îÄ R/ ‚îÇ ‚îú‚îÄ‚îÄ api-core.R ‚úì Complete (API layer) ‚îÇ ‚îú‚îÄ‚îÄ
chat-core.R ‚úì Complete (chat interface) ‚îÇ ‚îú‚îÄ‚îÄ chat-ui.R ‚úì Complete
(Shiny app main) ‚îÇ ‚îú‚îÄ‚îÄ chat-ui-components.R ‚úì Complete (UI components) ‚îÇ
‚îú‚îÄ‚îÄ chat-server-handlers.R ‚úì Complete (Server handlers) ‚îÇ ‚îú‚îÄ‚îÄ
chat-conversation.R ‚úì Complete (S7 ConversationManager) ‚îÇ ‚îú‚îÄ‚îÄ
chat-persistence.R ‚úì Complete (Save/load conversations) ‚îÇ ‚îú‚îÄ‚îÄ
chat-helpers.R ‚úì Complete (Write code/files) ‚îÇ ‚îú‚îÄ‚îÄ chat-css.R ‚úì Complete
(App styling + copy code button) ‚îÇ ‚îú‚îÄ‚îÄ chat-js.R ‚úì Complete (App
JavaScript + copy code button) ‚îÇ ‚îú‚îÄ‚îÄ context-project.R ‚úì Complete
(project context) ‚îÇ ‚îú‚îÄ‚îÄ context-data.R ‚úì Complete (data frame context) ‚îÇ
‚îú‚îÄ‚îÄ context-env.R ‚úì Complete (environment context) ‚îÇ ‚îú‚îÄ‚îÄ context-file.R
‚úì Complete (file context) ‚îÇ ‚îú‚îÄ‚îÄ context-combine.R ‚úì Complete (combine
contexts) ‚îÇ ‚îú‚îÄ‚îÄ context-tools.R ‚úì Complete (internal helpers) ‚îÇ ‚îú‚îÄ‚îÄ
scripts.R ‚úì Complete (script-to-quarto, commenting) ‚îÇ ‚îú‚îÄ‚îÄ utils.R ‚úì
Complete (%\|\|% operator) ‚îÇ ‚îú‚îÄ‚îÄ cassidyr-package.R ‚úì Complete (package
docs) ‚îÇ ‚îî‚îÄ‚îÄ addins.R ‚è≥ Phase 4 (RStudio/Positron addins) ‚îÇ ‚îú‚îÄ‚îÄ tests/ ‚îÇ
‚îú‚îÄ‚îÄ testthat/ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ test-api-core.R ‚úì Complete ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ
test-chat-core.R ‚úì Complete ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ test-context-project.R ‚úì Complete ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ test-context-data.R ‚úì Complete ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ test-context-environment.R
‚úì Complete ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ test-context-tools.R ‚úì Complete ‚îÇ ‚îî‚îÄ‚îÄ manual/ ‚îÇ ‚îú‚îÄ‚îÄ
test-api-live.R ‚îÇ ‚îú‚îÄ‚îÄ test-chat-live.R ‚îÇ ‚îî‚îÄ‚îÄ test-context-live.R ‚úì
Complete ‚îÇ ‚îî‚îÄ‚îÄ man/ (generated by roxygen2)

## Development Preferences

### Documentation Standards

- **roxygen2 with markdown** (@md in DESCRIPTION)
- All exported functions must have:
  - Complete parameter documentation
  - @return descriptions
  - @examples (with `\dontrun{}` for API calls)
  - @export tag for public functions
- Use markdown formatting in documentation
- Link related functions with @seealso
- Include usage examples that are realistic

### Testing Standards

- **testthat 3e** for all tests
- **Simplified testing approach** (not httptest2):
  - Unit tests validate R code logic without API calls
  - Mocking used sparingly (only when needed)
  - Manual tests verify real API integration
  - CRAN-compatible (no required API credentials)
- Test structure:
  - Use
    [`withr::with_tempdir()`](https://withr.r-lib.org/reference/with_tempfile.html)
    for file operations
  - Use `skip_if()` for environment-dependent tests
  - Use `skip_on_cran()` for system command tests
  - Test error handling and edge cases
- **Important**: Don‚Äôt test cli output text directly
  - cli functions write to stderr, not stdout
  - Use `expect_no_error()` instead of `expect_output()` for cli
    messages
  - Test structure and behavior, not exact formatting

### Code Style

- Follow tidyverse style guide
- Use [`paste0()`](https://rdrr.io/r/base/paste.html) for string
  concatenation (not [`sprintf()`](https://rdrr.io/r/base/sprintf.html))
- Prefer `|>` pipe for R \>= 4.1 examples
- Maximum line length: 80 characters
- Use meaningful variable names
- Comment complex logic

### Dependencies

- **Minimize dependencies** where reasonable
- Current imports:
  - httr2 (\>= 1.0.0) - HTTP requests
  - cli (\>= 3.6.0) - User interface
  - rlang (\>= 1.1.0) - Programming tools
- Suggested packages:
  - testthat (\>= 3.0.0)
  - withr
  - shiny - Chat UI
  - bslib - Modern theming
  - S7 - OOP for ConversationManager
  - markdown - Render chat messages
  - adlgraphs (for codebook)
  - skimr (for data summaries)
  - gert (for Git operations)
  - rstudioapi
- Prefer base R for simple operations

## API Details

### CassidyAI API

- **Base URL:** `https://app.cassidyai.com/api`
- **Authentication:** Bearer token in Authorization header
- **Environment Variables:**
  - `CASSIDY_API_KEY` - API key
  - `CASSIDY_ASSISTANT_ID` - Assistant ID
- **Endpoints:**
  - `POST /assistants/thread/create` - Create thread
  - `POST /assistants/message/create` - Send message
  - `GET /assistants/thread/get` - Get thread history
  - `GET /assistants/threads/get` - List threads
- **Retry Logic:**
  - Automatic retry on 429 (rate limit) and 503/504 (server errors)
  - Max 3 retries
  - 120-second timeout (configurable)

## Key Design Patterns

### S3 Objects

- `cassidy_response` - Single API response
- `cassidy_thread` - Thread with message history
- `cassidy_thread_list` - List of threads
- `cassidy_session` - Stateful chat session
- `cassidy_chat` - Chat result with thread info
- `cassidy_context` - Project context
- `cassidy_df_description` - Data frame description
- `cassidy_data_issues` - Data quality issues

### S7 Classes

- `ConversationManager` - Manages Shiny chat state with reactive values
  - Methods: `conv_get_all`, `conv_get_current`, `conv_update_current`,
    `conv_create_new`, `conv_switch_to`, `conv_delete`,
    `conv_add_message`, `conv_save_current`, `conv_load_and_set`

### Print Methods

- All S3 classes have print methods
- Use `cli` for formatted output (goes to stderr)
- Use [`cat()`](https://rdrr.io/r/base/cat.html) for actual content
  (goes to stdout)
- Always return invisibly: `invisible(x)`

### Context System

- Context sent **once at thread creation** (not per message)
- Tiered levels: minimal, standard, comprehensive
- Multiple methods with automatic fallback
- Configuration files automatically detected

### Conversation Persistence

- Conversations saved to
  `tools::R_user_dir("cassidyr", "data")/conversations/`
- Auto-save on message and session end
- Functions:
  [`cassidy_list_conversations()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_list_conversations.md),
  [`cassidy_export_conversation()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_export_conversation.md),
  [`cassidy_delete_conversation()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_delete_conversation.md)

## Common Development Tasks

### Adding a New Function

1.  Write function in appropriate `R/` file
2.  Add roxygen2 documentation with @export
3.  Document with
    [`devtools::document()`](https://devtools.r-lib.org/reference/document.html)
4.  Write tests in corresponding `tests/testthat/test-*.R`
5.  Add example to manual test file if needed
6.  Update README if it‚Äôs a major feature

### Testing Workflow

- Run all tests:
  [`devtools::test()`](https://devtools.r-lib.org/reference/test.html)
- Run specific test file:
  [`devtools::test_active_file()`](https://devtools.r-lib.org/reference/test.html)
- Check package:
  [`devtools::check()`](https://devtools.r-lib.org/reference/check.html)
- Manual testing: `source("tests/manual/test-context-live.R")`

## Common Pitfalls to Avoid

1.  **Don‚Äôt use [`sprintf()`](https://rdrr.io/r/base/sprintf.html)** -
    use paste0() instead
2.  **Don‚Äôt test cli output directly** - test structure/behavior instead
3.  **Don‚Äôt use `.format_num()` inside cli strings** - format values
    first
4.  **Don‚Äôt forget `skip_on_cran()`** for system commands
5.  **Don‚Äôt make git tests strict** - git behavior varies by environment
6.  **Always use
    [`suppressMessages()`](https://rdrr.io/r/base/message.html)** around
    [`use_cassidy_md()`](https://jdenn0514.github.io/cassidyr/reference/use_cassidy_md.md)
    in tests

## IDE Support

The package is designed to work across multiple IDEs:

- RStudio - Primary development environment
- Positron - Growing alternative, actively supported
- VS Code - With R extension
- Terminal - All features work in plain R

Functions detect IDE automatically and adapt behavior (e.g., file
opening).

## Development Phases

### ‚úÖ Phase 1: API Layer (Complete)

- [`cassidy_create_thread()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_create_thread.md) -
  Create conversation threads
- [`cassidy_send_message()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_send_message.md) -
  Send messages to assistants
- [`cassidy_get_thread()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_get_thread.md) -
  Retrieve thread history
- [`cassidy_list_threads()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_list_threads.md) -
  List available threads

### ‚úÖ Phase 2: Context System (Complete)

- [`cassidy_context_project()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_context_project.md) -
  Gather project context
- [`cassidy_context_data()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_context_data.md) -
  Describe data frames
- [`cassidy_context_env()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_context_env.md) -
  Environment information
- [`cassidy_describe_file()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_describe_file.md) -
  File summaries
- [`use_cassidy_md()`](https://jdenn0514.github.io/cassidyr/reference/use_cassidy_md.md) -
  Create configuration file

### ‚úÖ Phase 3: Interactive Shiny Chatbot (Complete)

- [`cassidy_app()`](https://jdenn0514.github.io/cassidyr/reference/cassidy_app.md) -
  Launch interactive Shiny chat interface
- Context integration - Automatic project/data context in chat
- Conversation persistence - Auto-save/load conversation history
- File context management - Add/remove/refresh files in context
- Conversation sidebar - Switch between multiple conversations
- Export conversations - Save chat history as markdown
- Mobile-responsive design - Collapsible sidebar, clean UI
- **Copy code button** - One-click copy for code blocks

### ‚è≥ Phase 4: IDE Integration (Next)

**Planned Features:**

- RStudio/Positron addins for code assistance
- `cassidy_document_function()` - Generate roxygen2 docs
- `cassidy_explain_selection()` - Explain selected code
- `cassidy_refactor_selection()` - Improve code
- `cassidy_debug_error()` - Help debug errors

**Implementation Notes:**

- Use `rstudioapi` when available
- Provide fallbacks for other IDEs
- Keep addins optional (in Suggests)
- Test across different environments

### üîÆ Phase 5: Agent System (Future)

- `cassidy_agent()` - Iterative problem solving
- `cassidy_execute_code()` - Safe code execution with sandboxing
- Multi-step workflows with state management
- Tool calling and function execution

### üîÆ Phase 6: Survey Research Tools (Future)

- `cassidy_interpret_efa()` - EFA interpretation with recommendations
- `cassidy_write_methods()` - Generate methods sections in APA format
- `cassidy_survey_codebook()` - Enhanced codebook for survey data
- `cassidy_scale_analysis()` - Comprehensive scale reliability analysis

## Important Context

- This package is **self-documenting** - it can use its own context
  system to help build itself
- When working on cassidyr, always gather context first with
  `cassidy_context_project(level = "comprehensive")`

## Package Development Status

- The package follows **ellmer‚Äôs testing pattern** for API tests
- Ready for **CRAN submission** after Phase 4 (IDE Integration)
- Built with **R 4.1+** in mind (native pipe `|>` support)
- Currently on **Phase 3 complete** - Interactive Shiny Chatbot
  implemented

## Communication Preferences

When providing help with cassidyr development:

1.  **Follow established patterns** - consistency matters across the
    codebase
2.  **Provide complete code blocks** - ready to copy and use
3.  **Include tests** - always provide corresponding tests for new
    functions
4.  **Update documentation** - include roxygen2 comments with all code
5.  **Explain design decisions** - help me understand the ‚Äúwhy‚Äù behind
    choices
6.  **Consider edge cases** - think about what could go wrong and handle
    it
7.  **Keep it simple** - prefer clear over clever code

## Code Review Checklist

Before finalizing any new code:

Function follows naming conventions (`cassidy_*` prefix)

All parameters documented with @param

@return value described

@examples provided (with `\dontrun{}` for API calls)

Tests pass with
[`devtools::test()`](https://devtools.r-lib.org/reference/test.html)

No hardcoded credentials or sensitive data

Error handling implemented with helpful messages

Works without optional dependencies (graceful fallbacks)

Documentation renders correctly with
[`devtools::document()`](https://devtools.r-lib.org/reference/document.html)

Package passes
[`devtools::check()`](https://devtools.r-lib.org/reference/check.html)
with no errors or warnings
