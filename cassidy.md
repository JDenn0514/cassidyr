# cassidyr Package Development Context

## Project Overview

**cassidyr** is an R package that provides a client for the CassidyAI API, enabling seamless integration of AI-powered assistants into R workflows. The package is designed with a security-first approach, tidyverse-style conventions, and follows R package development best practices.

## Package Information

- **Name:** cassidyr
- **Purpose:** R client for CassidyAI API with context-aware chat capabilities
- **Target Audience:** R users who want to integrate AI assistance into their workflows
- **Current Status:** Phase 2 complete (Context System), ready for Phase 3 (IDE Integration)

## Architecture & Design Philosophy

### Core Principles

1. **Security First**
   - No credentials in code - always use environment variables
   - Credentials stored in `.Renviron` (gitignored)
   - No real data in automated tests
   - Manual tests separate in `tests/manual/` (excluded from builds)

2. **Tidyverse Style**
   - All functions use snake_case
   - Pipe-friendly design
   - Clear, descriptive function names
   - Use native pipe `|>` in examples

3. **Naming Conventions**
   - All exported functions use `cassidy_` prefix
   - Layer-specific organization:
     - `cassidy_create_*`, `cassidy_send_*` (API functions)
     - `cassidy_chat()`, `cassidy_session()` (chat interface)
     - `cassidy_context_*()` (context gathering)
   - Internal helpers use `.` prefix (e.g., `.detect_ide()`)

4. **User-Friendly Errors**
   - Use `cli::cli_abort()` for errors with helpful messages
   - Validate inputs early and clearly
   - Provide actionable error messages

5. **Sensible Defaults**
   - Environment variables for credentials
   - Automatic fallbacks (e.g., codebook → skim → basic)
   - Works out of the box when possible

## Package Structure
cassidyr/
├── R/
│ ├── api-core.R ✓ Complete (API layer)
│ ├── chat-core.R ✓ Complete (chat interface)
│ ├── context-project.R ✓ Complete (project context)
│ ├── context-data.R ✓ Complete (data frame context)
│ ├── context-environment.R ✓ Complete (environment context)
│ ├── context-tools.R ✓ Complete (internal helpers)
│ ├── chat-ui.R ⏳ Future (Shiny UI)
│ └── addins.R ⏳ Future (RStudio/Positron addins)
│
├── tests/
│ ├── testthat/S
│ │ ├── test-api-core.R ✓ Complete
│ │ ├── test-chat-core.R ✓ Complete
│ │ ├── test-context-project.R ✓ Complete
│ │ ├── test-context-data.R ✓ Complete
│ │ ├── test-context-environment.R ✓ Complete
│ │ └── test-context-tools.R ✓ Complete
│ └── manual/
│ ├── test-api-live.R
│ ├── test-chat-live.R
│ └── test-context-live.R ✓ Complete
│
└── man/ (generated by roxygen2)

## Development Preferences

### Documentation Standards

- **roxygen2 with markdown** (@md in DESCRIPTION)
- All exported functions must have:
  - Complete parameter documentation
  - @return descriptions
  - @examples (with `\dontrun{}` for API calls)
  - @export tag for public functions
- Use markdown formatting in documentation
- Link related functions with @seealso
- Include usage examples that are realistic

### Testing Standards

- **testthat 3e** for all tests
- **Simplified testing approach** (not httptest2):
  - Unit tests validate R code logic without API calls
  - Mocking used sparingly (only when needed)
  - Manual tests verify real API integration
  - CRAN-compatible (no required API credentials)
- Test structure:
  - Use `withr::with_tempdir()` for file operations
  - Use `skip_if()` for environment-dependent tests
  - Use `skip_on_cran()` for system command tests
  - Test error handling and edge cases
- **Important**: Don't test cli output text directly
  - cli functions write to stderr, not stdout
  - Use `expect_no_error()` instead of `expect_output()` for cli messages
  - Test structure and behavior, not exact formatting

### Code Style

- Follow tidyverse style guide
- Use `paste0()` for string concatenation (not `sprintf()`)
- Prefer `|>` pipe for R >= 4.1 examples
- Maximum line length: 80 characters
- Use meaningful variable names
- Comment complex logic

### Dependencies

- **Minimize dependencies** where reasonable
- Current imports:
  - httr2 (>= 1.0.0) - HTTP requests
  - cli (>= 3.6.0) - User interface
  - rlang (>= 1.1.0) - Programming tools
- Suggested packages:
  - testthat (>= 3.0.0)
  - withr
  - adlgraphs (for codebook)
  - skimr (for data summaries)
  - gert (for Git operations)
  - rstudioapi
- Prefer base R for simple operations

## API Details

### CassidyAI API

- **Base URL:** `https://app.cassidyai.com/api`
- **Authentication:** Bearer token in Authorization header
- **Environment Variables:**
  - `CASSIDY_API_KEY` - API key
  - `CASSIDY_ASSISTANT_ID` - Assistant ID
- **Endpoints:**
  - `POST /assistants/thread/create` - Create thread
  - `POST /assistants/message/create` - Send message
  - `GET /assistants/thread/get` - Get thread history
  - `GET /assistants/threads/get` - List threads
- **Retry Logic:**
  - Automatic retry on 429 (rate limit) and 503/504 (server errors)
  - Max 3 retries
  - 60-second timeout

## Key Design Patterns

### S3 Objects

- `cassidy_response` - Single API response
- `cassidy_thread` - Thread with message history
- `cassidy_thread_list` - List of threads
- `cassidy_session` - Stateful chat session
- `cassidy_chat` - Chat result with thread info
- `cassidy_context` - Project context
- `cassidy_df_description` - Data frame description
- `cassidy_data_issues` - Data quality issues

### Print Methods

- All S3 classes have print methods
- Use `cli` for formatted output (goes to stderr)
- Use `cat()` for actual content (goes to stdout)
- Always return invisibly: `invisible(x)`

### Context System

- Context sent **once at thread creation** (not per message)
- Tiered levels: minimal, standard, comprehensive
- Multiple methods with automatic fallback
- Configuration files automatically detected

## Common Development Tasks

### Adding a New Function

1. Write function in appropriate `R/` file
2. Add roxygen2 documentation with @export
3. Document in `devtools::document()`
4. Write tests in corresponding `tests/testthat/test-*.R`
5. Add example to manual test file if needed
6. Update README if it's a major feature

### Testing Workflow

```r
# Run all tests
devtools::test()

# Run specific test file
devtools::test_active_file()

# Check package
devtools::check()

# Manual testing
source("tests/manual/test-context-live.R")
```

## Common pitfalls to avoid

1. **Don't use `sprintf()`** - use paste0() instead
2. **Don't test cli output directly** - test structure/behavior instead
3. **Don't use `.format_num()` inside cli strings** - format values first
4. **Don't forget `skip_on_cran()`** for system commands
5. **Don't make git tests strict** - git behavior varies by environment
6. **Always use `suppressMessages()`** around `use_cassidy_md()` in tests

## IDE Support

The package is designed to work across multiple IDEs:

- RStudio - Primary development environment
- Positron - Growing alternative, actively supported
- VS Code - With R extension
- Terminal - All features work in plain R

Functions detect IDE automatically and adapt behavior (e.g., file opening).

## Next Phase: Interactive Shiny Chatbot (Phase 3)

### Planned Features

- **Interactive chat interface** - Shiny app with {shinychat} and {bslib}
- **Context integration** - Automatic project/data context in chat
- **Session persistence** - Save and load conversation history
- **Code execution** - Run R code suggestions directly from chat
- **Multiple assistants** - Switch between different Cassidy assistants
- **Export conversations** - Save chat history as markdown/HTML

### Implementation Notes

- Use `shinychat::chat_ui()` and `chat_server()` for chat interface
- Use `bslib` for modern, themeable UI
- Main function: `cassidy_app()` to launch the app
- Context options in UI (minimal/standard/comprehensive)
- Real-time streaming responses if API supports it
- Keyboard shortcuts for common actions
- Mobile-responsive design

### Technical Considerations

- Keep UI dependencies in Suggests (not required for core functionality)
- Provide `cassidy_app()` as the main entry point
- Store chat history in temporary session or allow export
- Handle long-running API calls gracefully (progress indicators)
- Allow users to edit/retry messages
- Syntax highlighting for code blocks in responses

## Future Phases

### Phase 4: IDE Integration

**Planned Features:**

- RStudio/Positron addins for code assistance
- `cassidy_document_function()` - Generate roxygen2 docs
- `cassidy_explain_selection()` - Explain selected code
- `cassidy_refactor_selection()` - Improve code
- `cassidy_debug_error()` - Help debug errors

**Implementation Notes:**

- Use `rstudioapi` when available
- Provide fallbacks for other IDEs
- Keep addins optional (in Suggests)
- Test across different environments

### Phase 5: Agent System

**Planned Features:**

- `cassidy_agent()` - Iterative problem solving
- `cassidy_execute_code()` - Safe code execution with sandboxing
- Multi-step workflows with state management
- Tool calling and function execution
- Autonomous task completion

**Implementation Notes:**

- Implement retry logic and error recovery
- Provide hooks for custom tools/functions
- Safety checks for code execution
- Progress tracking for multi-step tasks

### Phase 6: Survey Research Tools

**Planned Features:**

- Domain-specific functions for survey analysis
- `cassidy_interpret_efa()` - EFA interpretation with recommendations
- `cassidy_write_methods()` - Generate methods sections in APA format
- `cassidy_survey_codebook()` - Enhanced codebook for survey data
- `cassidy_scale_analysis()` - Comprehensive scale reliability analysis

**Implementation Notes:**

- Integration with psych, lavaan, and semTools packages
- Templates for common survey analysis tasks
- Export to APA-formatted tables
- Integration with adlgraphs for visualization

## Important Context

- This package is **self-documenting** - it can use its own context system to help build itself
- When working on cassidyr, always gather context first:

```r
  ctx <- cassidy_context_project(level = "comprehensive")
```

## Package Development Status

- The package follows **ellmer's testing pattern** for API tests
- Ready for **CRAN submission** after Phase 3 (Shiny chatbot)
- Built with **R 4.1+** in mind (native pipe `|>` support)
- Currently on **Phase 2 complete** - Context System fully implemented

## Communication Preferences

When providing help with cassidyr development:

1. **Follow established patterns** - consistency matters across the codebase
2. **Provide complete code blocks** - ready to copy and use
3. **Include tests** - always provide corresponding tests for new functions
4. **Update documentation** - include roxygen2 comments with all code
5. **Explain design decisions** - help me understand the "why" behind choices
6. **Consider edge cases** - think about what could go wrong and handle it
7. **Keep it simple** - prefer clear over clever code

## Current Development Questions

When helping with new features, consider these key questions:

- [ ] **Naming conventions** - Does this follow the `cassidy_*` prefix pattern?
- [ ] **Testing** - Are there appropriate tests with `skip_if()` conditions where needed?
- [ ] **Documentation** - Is the documentation complete with @param, @return, @examples?
- [ ] **IDE compatibility** - Does it work across RStudio, Positron, VS Code, and terminal?
- [ ] **Error messages** - Are errors helpful, actionable, and use `cli::cli_abort()`?
- [ ] **Defaults** - Is the default behavior sensible and user-friendly?
- [ ] **Backward compatibility** - Does this maintain compatibility with existing code?
- [ ] **Dependencies** - Are new dependencies necessary or can we use base R?
- [ ] **Security** - Does this properly handle credentials and user data?

## Code Review Checklist

Before finalizing any new code:

- [ ] Function follows naming conventions
- [ ] All parameters documented with @param
- [ ] @return value described
- [ ] @examples provided (with `\dontrun{}` for API calls)
- [ ] Tests pass with `devtools::test()`
- [ ] No hardcoded credentials or sensitive data
- [ ] Error handling implemented with helpful messages
- [ ] Works without optional dependencies (graceful fallbacks)
- [ ] Documentation renders correctly with `devtools::document()`
- [ ] Package passes `devtools::check()` with no errors or warnings
